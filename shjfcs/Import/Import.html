<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>تسجيل تفتيش الاستيراد والتصدير</title>
<style>
    body { font-family: Arial, sans-serif; direction: rtl; background: #f9f9f9; margin: 0; padding: 20px; }
    h2 { text-align: center; }
    form { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); max-width: 900px; margin: auto; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, select, textarea { width: 100%; padding: 6px; margin-top: 4px; border-radius: 4px; border: 1px solid #ccc; }
    table { width: 100%; margin-top: 20px; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f0f0f0; }
    button { margin-top: 10px; padding: 8px 16px; border: none; background: #28a745; color: #fff; border-radius: 4px; cursor: pointer; }
    button:hover { background: #218838; }
    .remove-btn { background: #dc3545; }
    .remove-btn:hover { background: #c82333; }
</style>
</head>
<body>
<h2>تسجيل تفتيش الاستيراد والتصدير</h2>

<form id="inspectionForm">
    <label>رقم تسجيل النظام</label>
    <input type="text" name="system_registration_no" required>

    <label>أرقام الشحنات</label>
    <textarea name="shipment_numbers"></textarea>

    <label>عدد الحاويات</label>
    <input type="number" name="container_count">

    <label>أرقام الحاويات</label>
    <textarea name="container_numbers"></textarea>

    <label>تاريخ التسجيل</label>
    <input type="datetime-local" name="registration_date">

    <label>الميناء</label>
    <select name="entry_port_id" id="entry_port_id" required></select>

    <label>تاريخ التفتيش الفعلي</label>
    <input type="datetime-local" name="actual_inspection_date">

    <label>الإجراء المتخذ</label>
    <input type="text" name="action_taken">

    <label>ملاحظات</label>
    <textarea name="notes"></textarea>

    <h3>المنتجات المرتبطة بالفحص</h3>
    <table id="productsTable">
        <thead>
            <tr>
                <th>اسم المنتج</th>
                <th>العلامة التجارية</th>
                <th>الفئة</th>
                <th>بلد المنشأ</th>
                <th>نوع التعبئة</th>
                <th>الكمية</th>
                <th>الوزن</th>
                <th>تاريخ الإنتاج</th>
                <th>تاريخ الانتهاء</th>
                <th>Serial</th>
                <th>ملاحظات</th>
                <th>حذف</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <button type="button" onclick="addProductRow()">إضافة منتج</button>
    <button type="submit">حفظ الفحص والمنتجات</button>
</form>

<script>
// تحميل المنافذ
fetch('get_ports.php')
.then(res => res.json())
.then(data => {
    const select = document.getElementById('entry_port_id');
    data.forEach(port => {
        const opt = document.createElement('option');
        opt.value = port.ID;
        opt.textContent = port.name;
        select.appendChild(opt);
    });
});

// تحميل الفئات والبلدان عند إضافة منتج
let productCategories = [], countries = [];
fetch('get_product_categories.php').then(res => res.json()).then(data => productCategories = data);
fetch('get_countries.php').then(res => res.json()).then(data => countries = data);

function addProductRow() {
    const tbody = document.querySelector('#productsTable tbody');
    const tr = document.createElement('tr');

    tr.innerHTML = `
        <td><input name="product_name[]" required></td>
        <td><input name="brand_name[]"></td>
        <td>
            <select name="category_id[]" required>
                ${productCategories.map(cat => `<option value="${cat.CATEGORY_ID}">${cat.CATEGORY_NAME_EN}</option>`).join('')}
            </select>
        </td>
        <td>
            <select name="country_code[]" required>
                ${countries.map(c => `<option value="${c.ALPHA2_CODE}">${c.ENGLISH_NAME}</option>`).join('')}
            </select>
        </td>
        <td><input name="packaging_type[]"></td>
        <td><input type="number" step="0.01" name="quantity[]"></td>
        <td><input type="number" step="0.01" name="weight[]"></td>
        <td><input type="date" name="production_date[]"></td>
        <td><input type="date" name="expiry_date[]"></td>
        <td><input name="serial[]"></td>
        <td><input name="notes[]"></td>
        <td><button type="button" class="remove-btn" onclick="this.closest('tr').remove()">حذف</button></td>
    `;
    tbody.appendChild(tr);
}

// إرسال الفحص + المنتجات
document.getElementById('inspectionForm').addEventListener('submit', function(e){
    e.preventDefault();
    const formData = new FormData(this);
    fetch('add_import_with_products.php', {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(resp => {
        if(resp.success){
            alert('تم حفظ الفحص والمنتجات بنجاح!');
            location.reload();
        } else {
            alert('خطأ: ' + resp.message);
        }
    });
});
</script>
</body>
</html>
