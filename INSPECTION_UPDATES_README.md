# تحديثات نموذج التفتيش (Form Inspection Updates)

## التغييرات المنفذة (Implemented Changes)

### 1. زر "تفتيش جديد" (New Inspection Button)
- **الموقع**: يظهر بجانب زر البحث في قسم إدخال رقم الرخصة
- **الوظيفة**: عند البحث عن رخصة موجودة سابقاً، يمكن عرض البيانات مع إمكانية الضغط على "تفتيش جديد" لتفريغ الحقول وبدء تفتيش جديد بنفس رقم الرخصة
- **الملفات المعدلة**: `form_inspection.php`

### 2. رسالة تأكيد قبل الحفظ (Confirmation Before Save)
- **الوظيفة**: قبل حفظ سجل التفتيش، يظهر مودال تأكيد "هل أنت متأكد؟" لمنع الحفظ الخاطئ
- **التصميم**: مودال منبثق بأزرار "نعم، احفظ" و "إلغاء"
- **الملفات المعدلة**: `form_inspection.php` (HTML + JavaScript + CSS)

### 3. عرض المرفقات مع إمكانية الحذف (Attachments Display with Delete)
- **الموقع**: قسم جديد في نتائج التفتيش بعنوان "المرفقات الإضافية"
- **الوظيفة**: 
  - عرض قائمة بجميع ملفات PDF المرفقة بالتفتيش
  - زر "عرض" لفتح الملف في نافذة جديدة
  - زر "حذف" بجانب كل ملف مع تأكيد الحذف
  - تحديث الواجهة تلقائياً بعد الحذف دون إعادة تحميل الصفحة
- **الملفات المعدلة**: `form_inspection.php`, `api.php`

### 4. رفع ملفات بديلة (Upload Replacement Files)
- **الوظيفة**: بعد حذف ملف، أو في أي وقت، يمكن رفع ملفات PDF جديدة
- **الدعم**: يدعم رفع ملفات متعددة (multiple files)
- **القيود**: 
  - نوع الملف: PDF فقط
  - الحجم الأقصى: 10 ميجابايت لكل ملف
- **الملفات المعدلة**: `form_inspection.php`, `api.php`

### 5. نقطة نهاية API آمنة (Secure API Endpoint)
تم إضافة 3 نقاط نهاية جديدة في `api.php`:

#### `action=get_attachments`
- **الوظيفة**: جلب قائمة المرفقات لتفتيش معين
- **المعاملات**: `inspection_id`
- **الاستجابة**: JSON يحتوي على مصفوفة بيانات المرفقات

#### `action=delete_attachment`
- **الوظيفة**: حذف مرفق بشكل آمن
- **المعاملات**: `attachment_id`
- **التحقق من الصلاحيات**: 
  - يجب أن يكون المستخدم مسجل الدخول
  - يجب أن يكون المستخدم هو المفتش الذي أنشأ التفتيش أو مسؤول (admin)
- **العملية**: 
  1. التحقق من الصلاحيات
  2. حذف الملف من القرص (unlink)
  3. حذف السجل من قاعدة البيانات
- **الاستجابة**: `{ "success": true/false, "message": "..." }`

#### `action=upload_attachment`
- **الوظيفة**: رفع مرفقات جديدة
- **المعاملات**: `inspection_id`, `attachments[]` (files)
- **التحقق من الصلاحيات**: نفس قواعد delete_attachment
- **التحقق من الملفات**:
  - نوع الملف: PDF فقط
  - الحجم: أقل من 10MB
- **الاستجابة**: JSON يحتوي على بيانات الملفات المرفوعة

### 6. التوافق مع النظام الحالي (System Compatibility)
- **JavaScript**: يستخدم Vanilla JavaScript (لا يتطلب jQuery)
- **أسماء الحقول**: لم يتم تغيير أسماء الحقول الرئيسية
- **آليات الحفظ**: تم الحفاظ على آليات حفظ النموذج الموجودة

### 7. رسائل الخطأ والنجاح (Error/Success Messages)
- رسائل واضحة بالعربية عند كل عملية:
  - نجاح/فشل رفع الملف
  - نجاح/فشل حذف الملف
  - رسائل تأكيد قبل العمليات الحساسة

## قاعدة البيانات (Database)

### جدول جديد: `tbl_inspection_attachments`
```sql
CREATE TABLE IF NOT EXISTS `tbl_inspection_attachments` (
  `id` INT(11) NOT NULL AUTO_INCREMENT,
  `inspection_id` INT(11) NOT NULL,
  `filename` VARCHAR(255) NOT NULL,
  `file_path` VARCHAR(500) NOT NULL,
  `file_size` INT(11) DEFAULT NULL,
  `uploaded_by_user_id` INT(11) DEFAULT NULL,
  `uploaded_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_inspection_id` (`inspection_id`),
  CONSTRAINT `fk_attachment_inspection` FOREIGN KEY (`inspection_id`) 
    REFERENCES `tbl_inspections` (`inspection_id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**لتطبيق التغييرات على قاعدة البيانات:**
```bash
mysql -u username -p database_name < create_attachments_table.sql
```

## خطوات الاختبار (Testing Steps)

### 1. اختبار زر "تفتيش جديد"
1. افتح `form_inspection.php`
2. ابحث عن رقم رخصة موجود سابقاً
3. تأكد من ظهور بيانات المنشأة والتفتيش السابق
4. اضغط على زر "تفتيش جديد" (يظهر بجانب زر البحث)
5. تأكد من تفريغ حقول التفتيش مع بقاء بيانات المنشأة
6. أنشئ تفتيش جديد واحفظه

### 2. اختبار رسالة التأكيد قبل الحفظ
1. افتح تفتيش موجود أو أنشئ تفتيش جديد
2. املأ بعض البنود
3. اضغط على زر "حفظ البنود" (في أسفل الصفحة)
4. تأكد من ظهور مودال التأكيد "هل أنت متأكد من حفظ بنود التفتيش؟"
5. اضغط "إلغاء" - يجب أن يُغلق المودال دون حفظ
6. اضغط "حفظ" مرة أخرى ثم "نعم، احفظ" - يجب أن يتم الحفظ

### 3. اختبار عرض المرفقات والحذف
1. افتح تفتيش موجود به مرفقات (أو ارفع مرفقات جديدة أولاً)
2. في قسم "نتائج التفتيش"، انتقل إلى قسم "المرفقات الإضافية"
3. تأكد من ظهور قائمة المرفقات
4. اضغط على زر "عرض" - يجب أن يفتح PDF في نافذة جديدة
5. اضغط على زر "حذف" بجانب أحد المرفقات
6. أكد الحذف في رسالة التأكيد
7. تأكد من اختفاء المرفق من القائمة فوراً دون إعادة تحميل الصفحة
8. تأكد من ظهور رسالة "تم حذف المرفق بنجاح"

### 4. اختبار رفع ملفات جديدة
1. في قسم "المرفقات الإضافية"، اضغط على حقل "اختيار ملف"
2. اختر ملف PDF واحد أو عدة ملفات PDF
3. اضغط على زر "رفع مرفق جديد"
4. تأكد من ظهور رسالة "تم رفع المرفق بنجاح"
5. تأكد من ظهور الملف/الملفات الجديدة في القائمة
6. جرّب رفع ملف غير PDF - يجب أن يفشل
7. جرّب رفع ملف أكبر من 10MB - يجب أن يفشل

### 5. اختبار الصلاحيات
1. سجل الدخول كمستخدم عادي (non-admin)
2. حاول حذف مرفق من تفتيش قام به مستخدم آخر
3. يجب أن تظهر رسالة "لا تملك صلاحية حذف هذا المرفق"
4. سجل الدخول كمسؤول (admin)
5. يجب أن تتمكن من حذف أي مرفق
6. سجل الدخول كالمفتش الأصلي
7. يجب أن تتمكن من حذف مرفقاتك

### 6. اختبار الأمان
1. حاول الوصول إلى `api.php?action=delete_attachment&attachment_id=1` مباشرة من المتصفح دون تسجيل دخول
2. يجب أن تحصل على رسالة خطأ
3. حاول رفع ملف PHP بامتداد .pdf
4. يجب أن يفشل التحميل

## الملفات المعدلة (Modified Files)

1. `form_inspection.php` - التعديلات الرئيسية:
   - إضافة زر "تفتيش جديد"
   - إضافة مودال التأكيد (HTML + CSS)
   - إضافة قسم المرفقات (HTML + CSS)
   - إضافة JavaScript لإدارة المرفقات والتأكيد

2. `api.php` - إضافة نقاط النهاية:
   - `get_attachments`
   - `delete_attachment`
   - `upload_attachment`

3. `create_attachments_table.sql` - ملف SQL لإنشاء جدول المرفقات

## ملاحظات الأمان (Security Notes)

✅ **تم تطبيق:**
- التحقق من جلسة المستخدم قبل أي عملية
- التحقق من صلاحيات المستخدم (المفتش الأصلي أو مسؤول)
- التحقق من نوع الملف (PDF فقط)
- التحقق من حجم الملف (أقصى 10MB)
- استخدام Prepared Statements لمنع SQL Injection
- تسجيل الأخطاء في ملف log
- حذف الملف الفعلي والسجل من قاعدة البيانات معاً

⚠️ **توصيات إضافية:**
- تأكد من أن مجلد `uploads/inspections/attachments/` محمي من التنفيذ المباشر
- استخدم `.htaccess` لمنع تنفيذ PHP في مجلد الرفع
- فكر في إضافة scan للفيروسات على الملفات المرفوعة
- احتفظ بنسخ احتياطية منتظمة

## متطلبات النظام (System Requirements)

- PHP 7.4 أو أحدث
- MySQL 5.7 أو أحدث
- مساحة تخزين كافية لملفات PDF (10MB لكل ملف)
- صلاحيات كتابة على مجلد `uploads/inspections/attachments/`

## الدعم والمساعدة (Support)

للمساعدة أو الإبلاغ عن مشاكل، يرجى:
1. التحقق من ملف `error.log` للأخطاء
2. التأكد من تطبيق تحديثات قاعدة البيانات
3. التحقق من صلاحيات المجلدات
